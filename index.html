<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Communauté d’Atloc · ASC</title>
  <meta name="description" content="Portail public de la Communauté d’Atloc. Accès interne ASC." />

  <!--
    ARG: indices possibles dans le code source.
    Identifiants test:
    identifiant: 0175
    mot de passe: 1234

    Niveau: 3
    Règle: au niveau 3, l’agent voit un petit groupe d’enfants.
    Incidents: tous visibles, mais détails complets seulement pour les enfants autorisés.
  -->

  <style>
    :root{
      --bg1:#fef3c7;
      --bg2:#dbeafe;
      --bg3:#dcfce7;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --card:#ffffff;
      --shadow: 0 12px 40px rgba(15,23,42,.10);
      --radius: 18px;

      --brand1:#fb7185;
      --brand2:#60a5fa;
      --brand3:#34d399;
      --brand4:#fbbf24;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --retroBg:#070a0f;
      --retroPanel:#0b1220;
      --retroLine:#1f2a37;
      --retroInk:#d1d5db;
      --retroMuted:#94a3b8;
      --retroAccent:#a7f3d0;
      --retroWarn:#fbbf24;
      --retroBad:#fb7185;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 10%, var(--bg2) 0%, transparent 55%),
        radial-gradient(1200px 700px at 80% 15%, var(--bg3) 0%, transparent 60%),
        radial-gradient(1200px 700px at 50% 85%, var(--bg1) 0%, transparent 60%),
        #fff;
      letter-spacing:.1px;
    }

    a{color:inherit;text-decoration:none}
    button,input{font-family:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 60px}

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      border-radius: 22px;
      padding:14px 16px;
      box-shadow: var(--shadow);
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:280px}
    .logo{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, #fff, #f8fafc);
      display:grid;place-items:center;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;inset:-40px;
      background: conic-gradient(from 180deg,
        transparent,
        rgba(251,113,133,.18),
        rgba(96,165,250,.18),
        rgba(52,211,153,.18),
        rgba(251,191,36,.18),
        transparent);
      animation: spin 10s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .logo span{
      position:relative;
      font-weight:900;
      letter-spacing:.8px;
      font-size:12px;
      color: var(--ink);
    }
    .brand h1{margin:0;font-size:14px;font-weight:850;line-height:1.15}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}

    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: transform .08s ease, background .2s ease;
    }
    .chip:hover{transform: translateY(-1px);background:#fff}
    .chip[aria-current="page"]{
      border-color: rgba(96,165,250,.55);
      background: rgba(219,234,254,.7);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.5fr .85fr;
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:unset}
    }

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader h2{margin:0;font-size:14px;font-weight:850}
    .cardHeader .sub{margin:4px 0 0;color:var(--muted);font-size:12px;line-height:1.45}
    .cardBody{padding:18px}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .badge.fun{border-color: rgba(251,191,36,.35); background: rgba(255,251,235,.8); color:#92400e}
    .badge.fun .dot{background: var(--brand4)}
    .badge.aam{border-color: rgba(96,165,250,.35); background: rgba(239,246,255,.85); color:#1d4ed8}
    .badge.aam .dot{background: var(--brand2)}
    .badge.asc{border-color: rgba(52,211,153,.28); background: rgba(240,253,244,.85); color:#065f46}
    .badge.asc .dot{background: var(--brand3)}

    .notice{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(248,250,252,.75));
    }
    .small{font-size:12px}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:14px 0}

    .tiles{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .tiles{grid-template-columns:1fr}
    }
    .tile{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      background:#fff;
    }
    .tile .t{font-weight:850;font-size:12px;margin:0 0 6px}
    .tile .d{font-size:12px;color:var(--muted);margin:0;line-height:1.4}
    .pill{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
    }

    .field{display:grid;gap:8px;margin-top:12px}
    label{font-size:12px;color:var(--muted)}
    input{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 16px;
      padding:10px 12px;
      font-size:12px;
      outline:none;
    }
    input:focus{border-color: rgba(96,165,250,.65); box-shadow: 0 0 0 3px rgba(96,165,250,.20)}
    .btnRow{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:12px}
    .btn{
      width:100%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 12px;
      font-size:12px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(96,165,250,.95), rgba(37,99,235,.95));
      color:#fff;
      transition: transform .08s ease, opacity .2s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{
      background:#fff;
      color: var(--ink);
    }

    .footer{
      margin-top:14px;
      font-size:11px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* =========================
       LOADING RETRO PLEIN ÉCRAN
       ========================= */
    .loadingOverlay{
      position:fixed;
      inset:0;
      display:none;
      z-index: 200;
      background: radial-gradient(1000px 600px at 30% 10%, rgba(167,243,208,.08), transparent 60%), var(--retroBg);
      color: var(--retroInk);
      font-family: var(--mono);
      padding:18px;
    }
    .loadingBox{
      max-width: 920px;
      margin: 0 auto;
      padding: 26px 16px;
      border:1px solid var(--retroLine);
      border-radius: 16px;
      background: rgba(11,18,32,.72);
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
    }
    .loadingTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .loadingTitle h3{
      margin:0;
      font-size:12px;
      font-weight:800;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--retroInk);
    }
    .kbd{
      border:1px solid var(--retroLine);
      border-radius: 10px;
      padding:6px 10px;
      font-size:11px;
      color: var(--retroMuted);
      background: rgba(7,10,15,.65);
    }
    .log{
      margin-top:14px;
      border:1px solid var(--retroLine);
      border-radius: 14px;
      background: rgba(7,10,15,.65);
      padding:12px;
      min-height: 250px;
      line-height: 1.55;
      font-size:12px;
      white-space:pre-wrap;
    }
    .bar{
      margin-top:12px;
      height:10px;
      border:1px solid var(--retroLine);
      border-radius:999px;
      overflow:hidden;
      background: rgba(7,10,15,.65);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(167,243,208,.25), rgba(251,191,36,.25));
    }
    .blink{animation: blink 1.1s steps(1,end) infinite}
    @keyframes blink{0%,70%{opacity:1}71%,100%{opacity:.35}}

    /* =========================
       MODE INTERNE RETRO
       ========================= */
    body.internal{
      background: radial-gradient(1000px 600px at 40% 0%, rgba(167,243,208,.06), transparent 60%), var(--retroBg);
      color: var(--retroInk);
      font-family: var(--mono);
      letter-spacing: .15px;
    }
    body.internal .topbar{
      border-color: var(--retroLine);
      background: rgba(7,10,15,.72);
      box-shadow: 0 22px 90px rgba(0,0,0,.40);
    }
    body.internal .logo{
      border-color: var(--retroLine);
      background: rgba(7,10,15,.65);
    }
    body.internal .logo::after{opacity:.15}
    body.internal .logo span{color: var(--retroInk); letter-spacing:2px}
    body.internal .chip{
      border-color: var(--retroLine);
      background: rgba(11,18,32,.65);
      color: var(--retroInk);
    }
    body.internal .chip[aria-current="page"]{
      border-color: rgba(167,243,208,.20);
      background: rgba(167,243,208,.06);
    }
    body.internal .card{
      border-color: var(--retroLine);
      background: rgba(11,18,32,.72);
      box-shadow: 0 22px 90px rgba(0,0,0,.35);
    }
    body.internal .cardHeader{border-bottom-color: var(--retroLine)}
    body.internal .cardHeader .sub{color: var(--retroMuted)}
    body.internal .divider{background: var(--retroLine)}
    body.internal .badge{
      border-color: var(--retroLine);
      background: rgba(7,10,15,.65);
      color: var(--retroMuted);
    }
    body.internal .dot{background: #334155}
    body.internal .notice{
      border-color: var(--retroLine);
      background: rgba(7,10,15,.62);
    }
    body.internal .tile{
      border-color: var(--retroLine);
      background: rgba(7,10,15,.62);
    }
    body.internal input{
      border-color: var(--retroLine);
      background: rgba(7,10,15,.62);
      color: var(--retroInk);
    }
    body.internal input:focus{
      border-color: rgba(167,243,208,.25);
      box-shadow: 0 0 0 3px rgba(167,243,208,.10);
    }
    body.internal .btn{
      background: rgba(7,10,15,.62);
      color: var(--retroInk);
      border-color: var(--retroLine);
    }
    body.internal .btn.secondary{
      background: rgba(11,18,32,.62);
      color: var(--retroInk);
      border-color: var(--retroLine);
    }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
    }
    .table th,.table td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    body.internal .table th, body.internal .table td{
      border-bottom-color: var(--retroLine);
    }
    .table th{
      color: var(--muted);
      font-weight:800;
      background: rgba(248,250,252,.75);
    }
    body.internal .table th{
      color: var(--retroMuted);
      background: rgba(7,10,15,.62);
    }
    .rowLink{cursor:pointer}
    .rowLink:hover td{background: rgba(96,165,250,.08)}
    body.internal .rowLink:hover td{background: rgba(167,243,208,.06)}

    .redact{
      display:inline-block;
      border-radius: 8px;
      padding:2px 6px;
      background: repeating-linear-gradient(
        90deg,
        rgba(0,0,0,.85) 0px,
        rgba(0,0,0,.85) 10px,
        rgba(0,0,0,.75) 10px,
        rgba(0,0,0,.75) 18px
      );
      color: rgba(0,0,0,0);
      user-select:none;
    }
    body.internal .redact{
      background: repeating-linear-gradient(
        90deg,
        rgba(0,0,0,.75) 0px,
        rgba(0,0,0,.75) 12px,
        rgba(0,0,0,.65) 12px,
        rgba(0,0,0,.65) 20px
      );
    }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      width:min(420px, calc(100vw - 32px));
      display:none;
      z-index: 300;
      border-radius: 16px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(15,23,42,.92);
      color:#fff;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
    }
    body.internal .toast{
      border-color: rgba(31,42,55,.85);
      background: rgba(7,10,15,.92);
      box-shadow: 0 18px 70px rgba(0,0,0,.40);
    }
    .toast .t1{font-size:12px;font-weight:850}
    .toast .t2{font-size:12px;color:rgba(255,255,255,.78);margin-top:4px;line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>ATLOC</span></div>
        <div>
          <h1 id="brandTitle">La Communauté d’Atloc</h1>
          <p id="brandSub">Optimisme, entraide, accès simple</p>
        </div>
      </div>

      <nav class="nav" aria-label="Navigation">
        <div class="chip" data-page="accueil" aria-current="page">Accueil</div>
        <div class="chip" data-page="communaute">La Communauté</div>
        <div class="chip" data-page="transports">Transports AAM</div>
        <div class="chip" data-page="missions">Missions ASC</div>
        <div class="chip" data-page="connexion">Connexion</div>
      </nav>
    </header>

    <main class="grid" id="publicGrid">
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2 id="publicTitle">Bienvenue à Atloc</h2>
            <div class="sub" id="publicSub">Une ville qui avance ensemble, avec des services clairs et une énergie positive.</div>
          </div>
          <div class="badge fun" id="publicBadge"><span class="dot"></span><span>PORTAIL PUBLIC</span></div>
        </div>

        <div class="cardBody" id="publicBody">
          <div class="notice">
            <div class="small">
              <strong>Ce que tu peux faire ici</strong><br />
              Découvrir la Communauté, préparer un trajet AAM, comprendre les missions d’accompagnement, trouver des points de contact.
            </div>
          </div>

          <div class="divider"></div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Communauté Hall d’Aurore</p>
              <p class="d">Le symbole de l’entraide. Accessible via métro A (rouge) et Central Line (orange).</p>
              <div style="margin-top:10px"><span class="pill">Hall</span> <span class="pill">8 étages</span></div>
            </div>
            <div class="tile">
              <p class="t">AAM</p>
              <p class="d">Une mobilité simple. Plans clairs. Correspondances lisibles. Tout est pensé pour toi.</p>
              <div style="margin-top:10px"><span class="pill">Métro</span> <span class="pill">Plans</span></div>
            </div>
            <div class="tile">
              <p class="t">ASC</p>
              <p class="d">Un service partenaire, mandaté sur certaines situations sensibles, en lien avec le gouvernement d’Atloc.</p>
              <div style="margin-top:10px"><span class="pill">Missions</span> <span class="pill">Enfants</span></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="small muted">
            Conseil: commence par <span class="pill">Transports AAM</span> si tu veux rejoindre le Hall d’Aurore.
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="cardHeader">
          <div>
            <h2>Accès rapide</h2>
            <div class="sub">Portail de contact et espace interne ASC</div>
          </div>
          <div class="badge asc"><span class="dot"></span><span>ASC</span></div>
        </div>
        <div class="cardBody">
          <div class="notice">
            <div class="small">
              <strong>Mandat</strong><br />
              Certaines équipes sont mandatées par l’ASC pour retrouver des enfants et sécuriser un retour vers Atloc.
            </div>
          </div>

          <div class="divider"></div>

          <div id="loginBox">
            <div class="small muted">
              Espace interne. Ne pas utiliser si tu n’es pas habilité.
            </div>

            <div class="field">
              <label for="u">Identifiant</label>
              <input id="u" autocomplete="off" inputmode="numeric" placeholder="ex: 0175" />
            </div>
            <div class="field">
              <label for="p">Mot de passe</label>
              <input id="p" type="password" autocomplete="off" placeholder="●●●●" />
            </div>

            <div class="btnRow">
              <button class="btn" id="loginBtn">Se connecter</button>
              <button class="btn secondary" id="demoBtn">Test</button>
            </div>

            <div class="footer">
              <span>Support: Communauté</span>
              <span class="muted">Accès enregistré</span>
            </div>
          </div>

          <div id="loggedBox" style="display:none">
            <div class="notice">
              <div class="small">
                <strong>Session ouverte</strong><br />
                Accès interne prêt. Niveau détecté: <span class="pill">3</span>
              </div>
            </div>
            <div class="divider"></div>
            <button class="btn" id="enterBtn">Accéder à l’interface</button>
            <div class="footer">
              <span class="muted">Interface interne</span>
              <span class="pill">ASC</span>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <main id="internalGrid" style="display:none;margin-top:18px">
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2>ASC · Console interne</h2>
            <div class="sub" id="internalSub">interface administrative, mode lecture, lenteur normale</div>
          </div>
          <div class="badge"><span class="dot"></span><span>ACCRÉDITATION <span id="lvlText">3</span></span></div>
        </div>

        <div class="cardBody">
          <div class="tiles" style="grid-template-columns:repeat(3,1fr)">
            <div class="tile">
              <p class="t">Agent</p>
              <p class="d"><span class="pill" id="agentText">0175</span></p>
              <p class="d muted">affectation: Atloc</p>
            </div>
            <div class="tile">
              <p class="t">Droits</p>
              <p class="d">niveau <span class="pill">3</span> sur <span class="pill">10</span></p>
              <p class="d muted">certains champs sont masqués</p>
            </div>
            <div class="tile">
              <p class="t">Niveaux</p>
              <p class="d">voir niveaux <span class="pill">1</span> <span class="pill">2</span> <span class="pill">3</span></p>
              <p class="d muted">niveaux supérieurs indisponibles</p>
            </div>
          </div>

          <div class="divider"></div>

          <div class="btnRow" style="grid-template-columns:repeat(4,1fr)">
            <button class="btn secondary tabBtn" data-tab="dossiers">Dossiers</button>
            <button class="btn secondary tabBtn" data-tab="incidents">Incidents</button>
            <button class="btn secondary tabBtn" data-tab="recherche">Recherche</button>
            <button class="btn secondary" id="logoutBtn">Fermer</button>
          </div>

          <div class="divider"></div>

          <div id="tab_dossiers">
            <div class="notice">
              <div class="small">
                Dossiers visibles pour cet agent: <span class="pill" id="countMine">0</span>.<br />
                Les champs non nécessaires ne sont pas affichés.
              </div>
            </div>

            <div class="divider"></div>

            <table class="table" aria-label="Dossiers">
              <thead>
                <tr>
                  <th>ID enfant</th>
                  <th>Accès</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="mineTbody"></tbody>
            </table>

            <div class="small muted" style="margin-top:10px">
              Conseil interne: ne pas chercher par mots. Rechercher par référence exacte.
            </div>
          </div>

          <div id="tab_incidents" style="display:none">
            <div class="notice">
              <div class="small">
                Incidents: tous affichés.<br />
                Détails complets uniquement pour les enfants autorisés. Les autres sont masqués.
              </div>
            </div>

            <div class="divider"></div>

            <table class="table" aria-label="Incidents">
              <thead>
                <tr>
                  <th>ID enfant</th>
                  <th>État</th>
                  <th>Raison</th>
                  <th>Lieu</th>
                </tr>
              </thead>
              <tbody id="incTbody"></tbody>
            </table>

            <div class="small muted" style="margin-top:10px">
              Mention: <span class="pill">décédé</span> est une valeur administrative.
            </div>
          </div>

          <div id="tab_recherche" style="display:none">
            <div class="notice">
              <div class="small">
                Recherche interne. Entrer une référence exacte.<br />
                Exemples: <span class="pill">M 44703</span> ou <span class="pill">INC 0131</span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="field" style="margin-top:0">
              <label for="q">Référence</label>
              <input id="q" class="mono" autocomplete="off" placeholder="référence exacte" />
            </div>

            <div class="btnRow">
              <button class="btn" id="searchBtn">Rechercher</button>
              <button class="btn secondary" id="clearBtn">Effacer</button>
            </div>

            <div class="divider"></div>

            <div id="resultBox" class="notice">
              <div class="small muted">aucune requête</div>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <div class="loadingOverlay" id="loading">
    <div class="loadingBox">
      <div class="loadingTitle">
        <h3>ASC INTERNAL LOADER</h3>
        <div class="kbd">CTRL+C sans effet</div>
      </div>
      <div class="log" id="log"></div>
      <div class="bar"><div id="barFill"></div></div>
      <div class="small" style="margin-top:10px;color:var(--retroMuted)">
        statut: <span class="blink" id="loadStatus">en cours</span>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true">
    <div class="t1" id="t1">Info</div>
    <div class="t2" id="t2">Message</div>
  </div>

  <script>
    const chips = Array.from(document.querySelectorAll(".chip"));
    const publicTitle = document.getElementById("publicTitle");
    const publicSub = document.getElementById("publicSub");
    const publicBody = document.getElementById("publicBody");

    const u = document.getElementById("u");
    const p = document.getElementById("p");
    const loginBtn = document.getElementById("loginBtn");
    const demoBtn = document.getElementById("demoBtn");
    const loginBox = document.getElementById("loginBox");
    const loggedBox = document.getElementById("loggedBox");
    const enterBtn = document.getElementById("enterBtn");

    const publicGrid = document.getElementById("publicGrid");
    const internalGrid = document.getElementById("internalGrid");

    const agentText = document.getElementById("agentText");
    const lvlText = document.getElementById("lvlText");
    const countMine = document.getElementById("countMine");

    const mineTbody = document.getElementById("mineTbody");
    const incTbody = document.getElementById("incTbody");

    const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
    const tabDossiers = document.getElementById("tab_dossiers");
    const tabIncidents = document.getElementById("tab_incidents");
    const tabRecherche = document.getElementById("tab_recherche");

    const logoutBtn = document.getElementById("logoutBtn");

    const q = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const resultBox = document.getElementById("resultBox");

    const loading = document.getElementById("loading");
    const logEl = document.getElementById("log");
    const barFill = document.getElementById("barFill");
    const loadStatus = document.getElementById("loadStatus");

    const toast = document.getElementById("toast");
    const t1 = document.getElementById("t1");
    const t2 = document.getElementById("t2");

    const state = {
      page: "accueil",
      logged: false,
      agent: null,
      level: 3
    };

    const PAGES = {
      accueil: {
        title: "Bienvenue à Atloc",
        sub: "Une ville qui avance ensemble, avec des services clairs et une énergie positive.",
        html: `
          <div class="notice">
            <div class="small">
              <strong>Atloc en une phrase</strong><br />
              Ici, la Communauté est un réflexe. Les voisins se connaissent. L’entraide est une habitude.
            </div>
          </div>

          <div class="divider"></div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Communauté Hall d’Aurore</p>
              <p class="d">Le symbole de l’optimisme. Accessible via métro A rouge et Central Line orange.</p>
              <div style="margin-top:10px"><span class="pill">8 étages</span> <span class="pill">central</span></div>
            </div>
            <div class="tile">
              <p class="t">Vie quotidienne</p>
              <p class="d">Ressources, accompagnement, activités. Une ville pensée pour respirer.</p>
              <div style="margin-top:10px"><span class="pill">entraide</span> <span class="pill">proximité</span></div>
            </div>
            <div class="tile">
              <p class="t">Accès simple</p>
              <p class="d">AAM relie les quartiers. Plans lisibles. Correspondances faciles.</p>
              <div style="margin-top:10px"><span class="pill">AAM</span> <span class="pill">métro</span></div>
            </div>
          </div>
        `
      },
      communaute: {
        title: "La Communauté",
        sub: "Un réseau d’aide concret, au quotidien, pour que personne ne reste seul.",
        html: `
          <div class="notice">
            <div class="small">
              <strong>Notre idée</strong><br />
              La Communauté n’est pas un slogan. C’est un lieu, des relais, des gens, des portes qui s’ouvrent.
            </div>
          </div>

          <div class="divider"></div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Le Hall d’Aurore</p>
              <p class="d">Accueil, orientation, ressources. Un point central à visiter.</p>
              <div style="margin-top:10px"><span class="pill">métro A</span> <span class="pill">central</span></div>
            </div>
            <div class="tile">
              <p class="t">Réseau de proximité</p>
              <p class="d">Des relais dans les quartiers. Des parcours simples.</p>
              <div style="margin-top:10px"><span class="pill">quartiers</span> <span class="pill">relais</span></div>
            </div>
            <div class="tile">
              <p class="t">Partenaires</p>
              <p class="d">Services spécialisés en lien avec les institutions d’Atloc.</p>
              <div style="margin-top:10px"><span class="pill">ASC</span> <span class="pill">gouvernement</span></div>
            </div>
          </div>
        `
      },
      transports: {
        title: "Transports AAM",
        sub: "Des trajets simples pour rejoindre les lieux essentiels de la ville.",
        html: `
          <div class="notice">
            <div class="small">
              <strong>AAM</strong><br />
              Lignes lisibles, stations identifiées, correspondances pratiques.
            </div>
          </div>

          <div class="divider"></div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Métro A</p>
              <p class="d">Couleur: rouge. Accès direct au Hall d’Aurore.</p>
              <div style="margin-top:10px"><span class="pill">A</span> <span class="pill">rouge</span></div>
            </div>
            <div class="tile">
              <p class="t">Central Line</p>
              <p class="d">Couleur: orange. Traverse le centre.</p>
              <div style="margin-top:10px"><span class="pill">central</span> <span class="pill">orange</span></div>
            </div>
            <div class="tile">
              <p class="t">Accessibilité</p>
              <p class="d">Les lieux essentiels sont prévus dans le réseau.</p>
              <div style="margin-top:10px"><span class="pill">clarté</span> <span class="pill">pratique</span></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="small muted">
            Pour toute question, rendez vous au Hall d’Aurore.
          </div>
        `
      },
      missions: {
        title: "Missions ASC",
        sub: "Un service partenaire, mandaté sur certaines situations sensibles.",
        html: `
          <div class="notice">
            <div class="small">
              <strong>Mandats</strong><br />
              Lorsque des enfants doivent être retrouvés puis accompagnés vers un retour sécurisé, l’ASC peut mandater une équipe.
            </div>
          </div>

          <div class="divider"></div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Retrouver</p>
              <p class="d">Repérer, guider, sécuriser. Priorité: ramener sans délai.</p>
              <div style="margin-top:10px"><span class="pill">mission</span> <span class="pill">terrain</span></div>
            </div>
            <div class="tile">
              <p class="t">Accompagner</p>
              <p class="d">Coordination avec la Communauté, arrivée encadrée à Atloc.</p>
              <div style="margin-top:10px"><span class="pill">Atloc</span> <span class="pill">parcours</span></div>
            </div>
            <div class="tile">
              <p class="t">Protéger</p>
              <p class="d">Dispositif en lien avec le gouvernement d’Atloc.</p>
              <div style="margin-top:10px"><span class="pill">institution</span> <span class="pill">ASC</span></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="small muted">
            Pour accéder aux outils internes, utilise le bouton Connexion.
          </div>
        `
      },
      connexion: {
        title: "Connexion",
        sub: "Espace interne réservé aux agents habilités.",
        html: `
          <div class="notice">
            <div class="small">
              <strong>Accès interne</strong><br />
              L’espace interne est distinct du portail public.
            </div>
          </div>

          <div class="divider"></div>

          <div class="small muted">
            Utilise le formulaire à droite.
          </div>
        `
      }
    };

    const AGENT_ACCESS = {
      "0175": {
        level: 3,
        childrenAllowed: ["M 44703","M 44590","M 44218"]
      }
    };

    const DOSSIERS = [
      { id:"M 44703" },
      { id:"M 44590" },
      { id:"M 44218" },
      { id:"M 44821" },
      { id:"M 44002" },
      { id:"M 43911" }
    ];

    const INCIDENTS = [
      { childId:"M 44703", state:"décédé", reason:"accident ferroviaire", place:"station non desservie (CPC)" },
      { childId:"M 44590", state:"décédé", reason:"chute", place:"couloir de service AAM" },
      { childId:"M 44218", state:"décédé", reason:"incident classé", place:"périmètre CPC" },

      { childId:"M 44821", state:"décédé", reason:"requalifié", place:"secteur résidentiel" },
      { childId:"M 44002", state:"décédé", reason:"indéterminé", place:"infrastructure transport" },
      { childId:"M 43911", state:"décédé", reason:"annexe indisponible", place:"lieu masqué" }
    ];

    function toastMsg(a,b){
      t1.textContent = a;
      t2.textContent = b;
      toast.style.display = "block";
      clearTimeout(toastMsg._t);
      toastMsg._t = setTimeout(() => toast.style.display = "none", 3600);
    }

    function setPage(key){
      state.page = key;
      chips.forEach(c => c.setAttribute("aria-current", c.dataset.page === key ? "page" : "false"));
      const p = PAGES[key] || PAGES.accueil;
      publicTitle.textContent = p.title;
      publicSub.textContent = p.sub;
      publicBody.innerHTML = p.html;
    }

    chips.forEach(ch => ch.addEventListener("click", () => setPage(ch.dataset.page)));

    function setTab(which){
      tabDossiers.style.display = which === "dossiers" ? "block" : "none";
      tabIncidents.style.display = which === "incidents" ? "block" : "none";
      tabRecherche.style.display = which === "recherche" ? "block" : "none";
    }

    tabBtns.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

    function redact(text){
      const n = Math.max(10, String(text).length);
      return `<span class="redact">${"█".repeat(n)}</span>`;
    }

    function populateInternal(agentId){
      const agent = AGENT_ACCESS[agentId];
      const allowed = new Set(agent.childrenAllowed);

      agentText.textContent = agentId;
      lvlText.textContent = String(agent.level);

      const mine = agent.childrenAllowed.slice();
      countMine.textContent = String(mine.length);

      mineTbody.innerHTML = "";
      mine.forEach(id => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td>autorisé</td>
          <td>${redact("notes")}</td>
        `;
        mineTbody.appendChild(tr);
      });

      incTbody.innerHTML = "";
      INCIDENTS.forEach(ev => {
        const tr = document.createElement("tr");
        tr.className = "rowLink";

        const isAllowed = allowed.has(ev.childId);
        const reason = isAllowed ? ev.reason : redact(ev.reason);
        const place = isAllowed ? ev.place : redact(ev.place);

        tr.innerHTML = `
          <td>${ev.childId}</td>
          <td>${ev.state}</td>
          <td>${reason}</td>
          <td>${place}</td>
        `;
        incTbody.appendChild(tr);
      });
    }

    async function playLoader(){
      loading.style.display = "block";
      logEl.textContent = "";
      barFill.style.width = "0%";
      loadStatus.textContent = "en cours";

      const lines = [
        "INITIALISATION...",
        "VÉRIFICATION DES DROITS...",
        "CHARGEMENT MODULE DOSSIERS...",
        "CHARGEMENT MODULE INCIDENTS...",
        "CHARGEMENT MODULE RECHERCHE...",
        "SYNCHRONISATION AAM...",
        "RÉCUPÉRATION DES LISTES...",
        "NETTOYAGE DES CHAMPS NON NÉCESSAIRES...",
        "PRÊT."
      ];

      for(let i=0;i<lines.length;i++){
        logEl.textContent += lines[i] + "\n";
        const pct = Math.round(((i+1)/lines.length)*100);
        barFill.style.width = pct + "%";
        const wait = 260 + Math.floor(Math.random()*520);
        await new Promise(r => setTimeout(r, wait));
      }

      loadStatus.textContent = "terminé";
      await new Promise(r => setTimeout(r, 450));
      loading.style.display = "none";
    }

    function normalizeRef(s){
      return (s || "")
        .replace(/[-_]/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .toUpperCase();
    }

    function doSearch(){
      const raw = q.value || "";
      const key = normalizeRef(raw);

      if(!key){
        resultBox.innerHTML = `<div class="small muted">aucune requête</div>`;
        return;
      }

      const agent = AGENT_ACCESS[state.agent];
      const allowed = new Set(agent.childrenAllowed);

      const dossier = DOSSIERS.find(d => d.id === key);
      if(dossier){
        const ok = allowed.has(dossier.id);
        resultBox.innerHTML = ok
          ? `<div class="small">dossier ${dossier.id}<br />statut: clos<br />historique: non nécessaire</div>`
          : `<div class="small">dossier ${dossier.id}<br />${redact("contenu")}</div>`;
        return;
      }

      const inc = INCIDENTS.find(i => i.childId === key || ("INC " + i.childId.replace("M ","")) === key);
      if(inc){
        const ok = allowed.has(inc.childId);
        resultBox.innerHTML = ok
          ? `<div class="small">incident lié à ${inc.childId}<br />état: ${inc.state}<br />raison: ${inc.reason}<br />lieu: ${inc.place}</div>`
          : `<div class="small">incident lié à ${inc.childId}<br />état: ${inc.state}<br />raison: ${redact("raison")}<br />lieu: ${redact("lieu")}</div>`;
        return;
      }

      const forbidden = ["ENFANT","MORT","MEURTRE","DISPARITION","ASE","ATLOC","CPC","DÉCÈS","DECES"];
      if(forbidden.includes(key)){
        resultBox.innerHTML = `<div class="small">0 résultat<br />affiner la requête</div>`;
        return;
      }

      if(key === "DÉCÉDÉ" || key === "DECEDÉ" || key === "DECÉDÉ"){
        resultBox.innerHTML = `<div class="small">décédé<br />décédé<br />décédé<br />${redact("annexe")}</div>`;
        return;
      }

      resultBox.innerHTML = `<div class="small">aucun résultat<br />cette information peut ne pas avoir existé</div>`;
    }

    async function enterInternal(){
      await playLoader();

      document.body.classList.add("internal");
      document.getElementById("brandTitle").textContent = "ASC · Interface interne";
      document.getElementById("brandSub").textContent = "mode administratif, affichage partiel";
      internalGrid.style.display = "block";
      publicGrid.style.display = "none";

      setTab("dossiers");
      populateInternal(state.agent);

      toastMsg("Interface", "session active, niveau 3");
    }

    function logout(){
      document.body.classList.remove("internal");
      document.getElementById("brandTitle").textContent = "La Communauté d’Atloc";
      document.getElementById("brandSub").textContent = "Optimisme, entraide, accès simple";

      internalGrid.style.display = "none";
      publicGrid.style.display = "grid";

      loginBox.style.display = "block";
      loggedBox.style.display = "none";

      state.logged = false;
      state.agent = null;

      u.value = "";
      p.value = "";
      q.value = "";
      resultBox.innerHTML = `<div class="small muted">aucune requête</div>`;

      setPage("accueil");
      toastMsg("Session", "fermée");
    }

    async function login(){
      const id = (u.value || "").trim();
      const pw = (p.value || "").trim();

      await new Promise(r => setTimeout(r, 220 + Math.floor(Math.random()*420)));

      if(id === "0175" && pw === "1234"){
        state.logged = true;
        state.agent = id;
        loginBox.style.display = "none";
        loggedBox.style.display = "block";
        toastMsg("Connexion", "validée");
      } else {
        toastMsg("Accès refusé", "tentative enregistrée");
        p.value = "";
        p.focus();
      }
    }

    loginBtn.addEventListener("click", login);
    demoBtn.addEventListener("click", () => { u.value = "0175"; p.value = "1234"; toastMsg("Test", "identifiants insérés"); });
    [u,p].forEach(el => el.addEventListener("keydown", e => { if(e.key === "Enter") login(); }));

    enterBtn.addEventListener("click", enterInternal);
    logoutBtn.addEventListener("click", logout);

    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => { q.value = ""; resultBox.innerHTML = `<div class="small muted">aucune requête</div>`; });
    q.addEventListener("keydown", e => { if(e.key === "Enter") doSearch(); });

    setPage("accueil");
  </script>
</body>
</html>
